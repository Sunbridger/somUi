/* eslint-disable no-console */

var fs = require('fs');
var render = require('json-templater/string');
var uppercamelcase = require('uppercamelcase');
var path = require('path');
var endOfLine = require('os').EOL;
var Components = require('../../components.json');

var OUTPUT_PATH = path.join(__dirname, '../../examples/index.js');
var INSTALL_COMPONENT_TEMPLATE = '    {{name}}';
var IMPORT_TEMPLATE = 'import {{name}} from \'{{path}}\';';
var MAIN_TEMPLATE = `/* Automatic generated by './build/bin/build-example-entry.js' */
import 'so-ui/lib/styles/index.css';
import 'main/styles/index.css';
import Vue from 'vue';
import SomUI from 'main';
import SoUI from 'so-ui';
import Tower from '@souche-f2e/tower'; // eslint-disable-line
import Statistics from '@souche-f2e/statistics';

{{include}}
import App from './components/app';
import Demo from './components/demo';
import router from './router-config';

Statistics.init({
    router: router,
    piwik: {
        userPhone: '15433333333',
        userId: 'dasouche',
        env: 'production',
        siteId: 'dev_site'
    },
    load: true
});

Vue.use(SomUI);
Vue.use(SoUI);
Vue.component('demo-block', Demo);


// 扩展组件
const components = [
{{install}}
];

components.map((component) => {
    Vue.use(component);
});

new Vue({ // eslint-disable-line
    el: '#app',
    router,
    render: h => h(App)
});
`;

var ComponentNames = Object.keys(Components.packages);

var includeComponentTemplate = [];
var installTemplate = [];

ComponentNames.forEach((name) => {
    var componentName = uppercamelcase(name);

    includeComponentTemplate.push(render(IMPORT_TEMPLATE, {
        name: componentName,
        path: Components.packages[name].slice(2)
    }));

    installTemplate.push(render(INSTALL_COMPONENT_TEMPLATE, {
        name: componentName,
        component: name
    }));
});

var template = render(MAIN_TEMPLATE, {
    include: includeComponentTemplate.join(endOfLine),
    install: installTemplate.join(`,${endOfLine}`)
});

fs.writeFileSync(OUTPUT_PATH, template);

console.log('[build entry] DONE:', OUTPUT_PATH);
